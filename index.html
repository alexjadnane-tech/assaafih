<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Choisis ton carnet :)</title>
<style>
  body{font-family:Helvetica,Arial,sans-serif;margin:2rem;text-align:center}
  h1{margin-bottom:10px}
  .grid{display:grid;grid-template-columns:repeat(20,40px);grid-gap:4px;justify-content:center;margin-top:20px}
  .edition{width:40px;height:40px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;border:1px solid #333;user-select:none;transition:all .2s}
  .edition.sold{background:#fff;color:rgba(0,0,0,0);border:none;cursor:not-allowed}
  .edition:hover:not(.sold){transform:scale(1.1)}
  #selectedEdition{margin-top:20px;font-size:18px}
  #payButton{margin-top:10px;padding:12px 30px;font-size:18px;background:#dd00ff;color:#fff;border:none;cursor:pointer;font-weight:bold;display:none}
  #error{color:#b00020;margin-top:12px}
  #debug{font-size:12px;color:#666;margin-top:8px;white-space:pre-wrap;text-align:left;max-width:900px;margin-left:auto;margin-right:auto}
</style>
</head>
<body>
  <h1>choose your edition !</h1>
  <p>click on a square to select one...</p>

  <div id="grid" class="grid"></div>

  <div id="selectedEdition">selected edition: <span id="editionNumber">Aucune</span></div>
  <button id="payButton">PAY!</button>

  <div id="error" aria-live="polite"></div>
  <pre id="debug"></pre>

<script>
(async function(){
  const $error = document.getElementById('error');
  const $debug = document.getElementById('debug');
  function debug(msg){ console.log(msg); $debug.textContent += msg + "\\n"; }

  // fetch links.json and sold.json with robust error handling
  async function loadJSON(path){
    try{
      const res = await fetch(path + '?_=' + Date.now(), {cache: 'no-store'});
      debug(`${path} → HTTP ${res.status}`);
      if(!res.ok){
        throw new Error(`${path} returned ${res.status}`);
      }
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch(e){
        debug(`Invalid JSON from ${path}:\\n${text}`);
        throw new Error(`Invalid JSON at ${path}`);
      }
    } catch(err){
      debug(`Error loading ${path}: ${err.message}`);
      throw err;
    }
  }

  let links = {};
  let sold = [];

  try{
    links = await loadJSON('/links.json');
    debug('links loaded: ' + Object.keys(links).length + ' items');
  } catch(err){
    $error.textContent = "Erreur: impossible de charger /links.json. Vérifie que /public/links.json existe et est déployé.";
    return;
  }

  try{
    sold = await loadJSON('/sold.json');
    if(!Array.isArray(sold)) sold = [];
  } catch(err){
    debug('sold.json missing or invalid — continuing with empty sold list');
    sold = [];
  }

  // build grid from the keys of links.json
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  const editions = Object.keys(links).map(n=>Number(n)).sort((a,b)=>a-b);

  if(editions.length === 0){
    $error.textContent = "Aucun lien trouvé dans links.json — ajoute au moins une entrée (ex: {\"11\":\"https://...\"}).";
    return;
  }

  let selectedEdition = null;
  const editionElements = {};

  function updateSelectionUI(n){
    document.getElementById('editionNumber').textContent = n || 'Aucune';
    document.getElementById('payButton').style.display = n ? 'inline-block' : 'none';
  }

  editions.forEach(num=>{
    const div = document.createElement('div');
    div.className = 'edition';
    div.textContent = num;
    const isSold = Array.isArray(sold) && sold.includes(Number(num));
    if(isSold) div.classList.add('sold');
    else {
      div.addEventListener('click', ()=>{
        // deselect others
        Object.values(editionElements).forEach(el => el.style.borderColor = '#333');
        div.style.borderColor = '#fff';
        selectedEdition = num;
        updateSelectionUI(num);
      });
    }
    editionElements[num] = div;
    grid.appendChild(div);
  });

  document.getElementById('payButton').addEventListener('click', ()=>{
    if(!selectedEdition) return;
    const url = links[selectedEdition];
    if(!url){ alert('Aucun lien trouvé pour cette édition'); return; }
    window.location.href = url;
  });

  debug('Grid rendered. Select a square.');
})();
</script>
</body>
</html>
