<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Choisis ton carnet</title>
<style>
  body { font-family: Helvetica, sans-serif; margin: 2rem; text-align: center; }
  .grid { display: grid; grid-template-columns: repeat(20, 40px); gap: 4px; justify-content: center; margin-top: 20px; }
  .edition { width: 40px; height: 40px; background:black; color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid #333; }
  .edition.sold { background:#fff; color:transparent; border:none; cursor:not-allowed; }
</style>
</head>
<body>

<h1>Choisis ton carnet !</h1>
<div class="grid" id="grid"></div>
<div id="selectedEdition">
  selected edition: <span id="editionNumber">Aucune</span>
</div>
<button id="payStripe" style="display:none">Pay Card</button>
<button id="payTwint" style="display:none">Pay Twint</button>

<script>
let selectedEdition = null;
let links = [];

async function fetchSold() {
  const res = await fetch('/api/sold-editions');
  return res.ok ? (await res.json()).map(Number) : [];
}

async function fetchLinks() {
  const res = await fetch('/links.json');
  links = await res.json();
}

async function generateGrid() {
  const sold = await fetchSold();
  await fetchLinks();

  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  for(let i=1;i<=200;i++){
    const div = document.createElement('div');
    div.classList.add('edition');
    div.textContent = i;

    if(sold.includes(i)) div.classList.add('sold');

    const linkObj = links.find(l => l.number === i);

    div.addEventListener('click', () => {
      if(div.classList.contains('sold')) return;
      selectedEdition = i;
      document.getElementById('editionNumber').textContent = i;

      if(linkObj){
        document.getElementById('payStripe').style.display = 'inline-block';
        document.getElementById('payTwint').style.display = 'inline-block';
      } else {
        document.getElementById('payStripe').style.display = 'none';
        document.getElementById('payTwint').style.display = 'none';
      }
    });

    grid.appendChild(div);
  }
}

document.getElementById('payStripe').addEventListener('click', () => {
  const linkObj = links.find(l=>l.number===selectedEdition);
  if(linkObj) window.open(linkObj.stripe,'_blank');
});

document.getElementById('payTwint').addEventListener('click', () => {
  const linkObj = links.find(l=>l.number===selectedEdition);
  if(linkObj) window.open(linkObj.twint,'_blank');
});

// Auto-refresh
setInterval(generateGrid,10000);
generateGrid();
</script>

</body>
</html>
