<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Choisis ton carnet :)</title>
<style>
body { font-family: Helvetica, sans-serif; margin:2rem; text-align:center;}
.grid {display:grid;grid-template-columns:repeat(20,40px);grid-gap:4px;justify-content:center;margin-top:20px;}
.edition {width:40px;height:40px;background:black;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;border:1px solid #333;user-select:none;transition:all .2s;}
.edition.sold {background:#fff;color:rgba(0,0,0,0);border:none;cursor:not-allowed;}
.edition:hover:not(.sold){transform:scale(1.1);}
#selectedEdition{margin-top:20px;font-size:18px;}
#payButton{margin-top:10px;padding:12px 30px;font-size:18px;background-color:#dd00ff;color:white;border:none;cursor:pointer;font-weight:bold;display:none;}
#payButton:hover:not(:disabled){background-color:#e600e6;}
</style>
</head>
<body>

<h1>Choose your edition!</h1>
<p>Click on a square to select one...</p>

<div class="grid" id="grid"></div>
<div id="selectedEdition">selected edition: <span id="editionNumber">Aucune</span></div>
<button id="payButton">PAY!</button>

<script>
let selectedEdition = null;

async function fetchSold() {
  try {
    const res = await fetch('/api/sold-editions');
    if(!res.ok) return [];
    return (await res.json()).map(Number);
  } catch { return []; }
}

async function generateGrid() {
  const sold = await fetchSold();
  const grid = document.getElementById('grid');
  grid.innerHTML='';
  for(let i=1;i<=200;i++){
    const div=document.createElement('div');
    div.classList.add('edition');
    div.textContent=i;
    div.dataset.edition=i;
    if(sold.includes(i)) div.classList.add('sold');

    div.addEventListener('click',()=>{
      if(div.classList.contains('sold')) return;
      document.querySelectorAll('.edition:not(.sold)').forEach(e=>e.style.borderColor='#333');
      div.style.borderColor='#fff';
      selectedEdition=i;
      document.getElementById('editionNumber').textContent=i;
      document.getElementById('payButton').style.display='inline-block';
    });
    grid.appendChild(div);
  }
}

generateGrid();
setInterval(generateGrid,10000);

document.getElementById('payButton').addEventListener('click',async()=>{
  if(!selectedEdition) return;
  const choice=prompt("Tape 'stripe' ou 'twint' pour choisir le paiement :");
  if(!choice) return;
  try{
    const res = await fetch('/api/payrexx-session',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({edition:selectedEdition,method:choice.toLowerCase()})
    });
    const data = await res.json();
    if(data.url) window.open(data.url,'_blank');
    else alert('Erreur création paiement');
  }catch{alert('Erreur réseau');}
});
</script>
</body>
</html>
